name: Update SPM Version and Create PR

on:
  repository_dispatch:
    types: [spm_version_updated]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout host app repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show received payload
        run: |
          echo "New SPM version received: ${{ github.event.client_payload.new_tag }}"


      - name: print resolved file
        run: |
          RESOLVED_FILE=$(find . -name "Package.resolved" | head -1)
          echo "Resolved file path: $RESOLVED_FILE"
          cat "$RESOLVED_FILE"

      - name: Update SPM version in Package.swift
        run: |
          NEW_TAG="${{ github.event.client_payload.new_tag }}"
          CLEAN_TAG="${NEW_TAG#v}"
          echo "ðŸ”§ Updating SPM version to $CLEAN_TAG"
      
          RESOLVED_FILE=$(find . -name "Package.resolved" | head -1)
          echo "Updating resolved file: $RESOLVED_FILE"
      
          # Fetch the commit hash (revision) based on the pushed tag
          REPO_URL="https://github.com/amit-pandey11/ServicesSPM.git"
          NEW_REVISION=$(git ls-remote "$REPO_URL" "refs/tags/$NEW_TAG" | cut -f1)
      
          echo "New revision hash: $NEW_REVISION"

          # cross platform sed
          if [[ "$OSTYPE" == "darwin"* ]]; then
            SED_CMD="sed -i ''"
          else
            SED_CMD="sed -i"
          fi
      
          # Update version
          $SED_CMD "s/\"version\"[ ]*:[ ]*\"[^\"]*\"/\"version\" : \"$CLEAN_TAG\"/" "$RESOLVED_FILE"
      
          # Update revision
          $SED_CMD "s/\"revision\"[ ]*:[ ]*\"[^\"]*\"/\"revision\" : \"$NEW_REVISION\"/" "$RESOLVED_FILE"
      
          cat "$RESOLVED_FILE"
      
          echo "âœ… Package.resolved updated successfully!"

      - name: Commit and push changes
        run: |
          NEW_TAG="${{ github.event.client_payload.new_tag }}"
          branch_name="update-spm-${NEW_TAG}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$branch_name"
          RESOLVED_FILE=$(find . -name "Package.resolved" | head -1)
          git add "$RESOLVED_FILE"
          git commit -m "chore: update SPM dependency to ${NEW_TAG}"
          git push origin "$branch_name"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Update SPM dependency to ${{ github.event.client_payload.new_tag }}"
          body: "This PR updates the SPM dependency to version **${{ github.event.client_payload.new_tag }}**."
          branch: "update-spm-${{ github.event.client_payload.new_tag }}"
          base: "main"
          commit-message: "chore: update SPM dependency to ${{ github.event.client_payload.new_tag }}"
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          commit: false
          delete-branch: false
